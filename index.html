<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WayneTech OS v4</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        :root { --primary: #00f7ff; --alert: #ff3333; --bg: #050505; --panel: rgba(0, 20, 20, 0.9); }
        body { margin: 0; background-color: var(--bg); font-family: 'Courier New', monospace; overflow: hidden; color: var(--primary); }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* UI SHELL */
        #active-viewport { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; display: flex; flex-direction: column; }
        
        .top-bar {
            height: 60px; display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.9); border-bottom: 2px solid var(--primary); padding: 0 20px; z-index: 10;
        }
        .close-btn { border: 1px solid var(--alert); color: var(--alert); background: transparent; padding: 5px 15px; font-weight: bold; }

        /* MENU FAB */
        #menu-fab {
            position: absolute; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%;
            border: 2px solid var(--primary); background: rgba(0,0,0,0.8); color: var(--primary);
            display: flex; justify-content: center; align-items: center; font-size: 24px; z-index: 999;
            box-shadow: 0 0 15px rgba(0, 247, 255, 0.3); transition: transform 0.2s;
        }
        #menu-fab:active { transform: scale(0.9); background: var(--primary); color: #000; }

        /* APP DRAWER */
        #app-drawer {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70%;
            background: var(--panel); border-top: 2px solid var(--primary);
            z-index: 998; transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            padding: 20px; border-radius: 20px 20px 0 0; display: flex; flex-direction: column;
        }
        #app-drawer.open { transform: translateY(0); }

        .drawer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; overflow-y: auto; }
        .app-icon {
            aspect-ratio: 1; border: 1px solid #004444; background: rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 9px; text-align: center; color: var(--primary); cursor: pointer;
        }
        .app-icon i { font-size: 20px; margin-bottom: 5px; display: block; }
        .app-icon:active { background: var(--primary); color: #000; }

        /* SHARED COMPONENTS */
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .tool-ui { position: absolute; top: 60px; left: 0; width: 100%; height: calc(100% - 60px); padding: 20px; overflow-y: auto; background: #000; }
        .overlay-ui { position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; pointer-events: none; z-index: 5; }
        
        input, textarea, select {
            width: 100%; background: #111; border: 1px solid var(--primary); color: var(--primary);
            padding: 10px; margin: 5px 0 15px 0; font-family: inherit; font-size: 16px;
        }
        button.action {
            width: 100%; padding: 15px; background: rgba(0, 247, 255, 0.1); border: 1px solid var(--primary);
            color: var(--primary); font-weight: bold; margin-bottom: 10px;
        }
        button.action:active { background: var(--primary); color: #000; }
        
        /* DATA DISPLAY */
        .log-box { font-size: 12px; border: 1px solid #333; padding: 10px; min-height: 50px; text-align: left; white-space: pre-wrap; }
    </style>
</head>
<body>

    <div id="active-viewport">
        <div style="display:flex; height:100%; justify-content:center; align-items:center; flex-direction:column; background: radial-gradient(circle, #111 0%, #000 100%);">
            <h1 style="text-shadow: 0 0 15px var(--primary);">WAYNETECH</h1>
            <small>OS v4.0 // OPTIMIZED KERNEL</small>
            <div style="margin-top:20px; font-size:12px; opacity:0.6;">SYSTEM STANDBY</div>
        </div>
    </div>

    <div id="menu-fab" onclick="toggleDrawer()">‚ò∞</div>

    <div id="app-drawer">
        <div style="text-align:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">GADGET SELECT</div>
        <div class="drawer-grid">
            <div class="app-icon" onclick="launch('detective')"><i>üëÅÔ∏è</i>DETECTIVE</div>
            <div class="app-icon" onclick="launch('vocoder')"><i>üó£Ô∏è</i>VOCODER</div>
            <div class="app-icon" onclick="launch('nightvis')"><i>üåë</i>NIGHT VIS</div>
            <div class="app-icon" onclick="launch('sonar')"><i>üì°</i>SONAR</div>
            <div class="app-icon" onclick="launch('crypto')"><i>üîê</i>DECRYPT</div>
            <div class="app-icon" onclick="launch('gps')"><i>üõ∞Ô∏è</i>GPS</div>
            <div class="app-icon" onclick="launch('flash')"><i>üí£</i>FLASHBANG</div>
            <div class="app-icon" onclick="launch('reflex')"><i>‚ö°</i>REFLEX</div>
            <div class="app-icon" onclick="launch('status')"><i>üîã</i>STATUS</div>
            <div class="app-icon" onclick="launch('jammer')"><i>üîä</i>JAMMER</div>
        </div>
    </div>

    <script>
        // === CORE SYSTEM ===
        const viewport = document.getElementById('active-viewport');
        const drawer = document.getElementById('app-drawer');
        let currentProcess = null; // Stores clean-up function

        function toggleDrawer() { drawer.classList.toggle('open'); }

        async function launch(appId) {
            if (currentProcess) currentProcess();
            currentProcess = null;

            toggleDrawer(); 
            viewport.innerHTML = `<div class="top-bar"><span>${appId.toUpperCase()}</span><button class="close-btn" onclick="exitApp()">EXIT</button></div>`;
            
            if(appId === 'detective') startDetective();
            else if(appId === 'vocoder') startVocoder();
            else if(appId === 'nightvis') startCamera('sepia(100%) hue-rotate(90deg) contrast(200%) brightness(150%)');
            else if(appId === 'sonar') startSonar();
            else if(appId === 'crypto') startCrypto();
            else if(appId === 'gps') startGPS();
            else if(appId === 'flash') startFlash();
            else if(appId === 'reflex') startReflex();
            else if(appId === 'status') startStatus();
            else if(appId === 'jammer') startJammer();
        }

        function exitApp() {
            if (currentProcess) currentProcess();
            currentProcess = null;
            viewport.innerHTML = `<div style="display:flex; height:100%; justify-content:center; align-items:center; flex-direction:column; background: #000;"><h1 style="color:#333;">STANDBY</h1></div>`;
        }

        // === HARDWARE HELPER ===
        async function getCamera() {
            const video = document.createElement('video');
            video.setAttribute('playsinline', '');
            video.muted = true;
            viewport.appendChild(video);
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                await video.play();
                return { video, stream };
            } catch(e) { alert("Camera Access Denied"); return null; }
        }

        // ============================================
        // === APP: VOCODER (Translate & OCR) ===
        // ============================================
        function startVocoder() {
            // Inject UI
            const container = document.createElement('div');
            container.className = 'tool-ui';
            container.innerHTML = `
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <button class="action" onclick="vocoderMode('text')" id="btn-mode-text">TEXT INPUT</button>
                    <button class="action" onclick="vocoderMode('cam')" id="btn-mode-cam">LIVE CAM</button>
                </div>
                
                <div id="vocoder-text-ui">
                    <textarea id="v-input" placeholder="Type text to translate..."></textarea>
                    <select id="v-lang">
                        <option value="es">SPANISH</option>
                        <option value="fr">FRENCH</option>
                        <option value="ja">JAPANESE</option>
                        <option value="de">GERMAN</option>
                        <option value="it">ITALIAN</option>
                    </select>
                    <button class="action" onclick="translateText()">TRANSLATE & SPEAK</button>
                    <div id="v-result" class="log-box">...</div>
                </div>

                <div id="vocoder-cam-ui" style="display:none; height:100%;">
                    <div id="cam-preview" style="position:relative; height:200px; background:#111; margin-bottom:10px; border:1px solid #00f7ff;">
                        <div style="position:absolute; top:50%; width:100%; text-align:center;">CAMERA OFF</div>
                    </div>
                    <button class="action" onclick="scanText()">SCAN IMAGE (OCR)</button>
                    <div id="ocr-result" class="log-box">Captured text will appear here...</div>
                </div>
            `;
            viewport.appendChild(container);

            // Logic
            window.vocoderMode = (mode) => {
                document.getElementById('vocoder-text-ui').style.display = mode === 'text' ? 'block' : 'none';
                document.getElementById('vocoder-cam-ui').style.display = mode === 'cam' ? 'block' : 'none';
                if(mode === 'cam') startOCRPreview();
                else stopOCRPreview();
            };

            // 1. Text Translation (Using Free API)
            window.translateText = async () => {
                const text = document.getElementById('v-input').value;
                const lang = document.getElementById('v-lang').value;
                const resBox = document.getElementById('v-result');
                
                if(!text) return;
                resBox.innerText = "UPLINKING TO TRANSLATION SERVER...";

                try {
                    const req = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${lang}`);
                    const data = await req.json();
                    const translation = data.responseData.translatedText;
                    
                    resBox.innerText = translation;
                    
                    // Speak it
                    const u = new SpeechSynthesisUtterance(translation);
                    u.lang = lang; 
                    speechSynthesis.speak(u);
                } catch(e) {
                    resBox.innerText = "CONNECTION FAILED.";
                }
            };

            // 2. Camera OCR (Tesseract)
            let videoEl = null;
            let streamRef = null;

            window.startOCRPreview = async () => {
                const prev = document.getElementById('cam-preview');
                prev.innerHTML = '';
                const setup = await getCamera(); 
                if(!setup) return;
                
                videoEl = setup.video;
                streamRef = setup.stream;
                
                videoEl.style.position = 'absolute';
                prev.appendChild(videoEl);
            };

            window.stopOCRPreview = () => {
                if(streamRef) streamRef.getTracks().forEach(t => t.stop());
                if(videoEl) videoEl.remove();
            };

            window.scanText = async () => {
                if(!videoEl) return;
                const resBox = document.getElementById('ocr-result');
                resBox.innerText = "ANALYZING VISUAL DATA...";
                
                // Draw frame to canvas
                const canvas = document.createElement('canvas');
                canvas.width = videoEl.videoWidth; 
                canvas.height = videoEl.videoHeight;
                canvas.getContext('2d').drawImage(videoEl, 0, 0);

                // Run Tesseract
                try {
                    const { data: { text } } = await Tesseract.recognize(canvas, 'eng');
                    resBox.innerText = text ? text : "NO TEXT DETECTED";
                    // Clean up text for speech
                    if(text) {
                        const u = new SpeechSynthesisUtterance("Visual data reads: " + text);
                        speechSynthesis.speak(u);
                    }
                } catch(e) {
                    resBox.innerText = "OCR MODULE FAILURE";
                }
            };

            // Cleanup function
            currentProcess = () => { window.stopOCRPreview(); };
        }

        // ============================================
        // === APP: DETECTIVE (Object Detection) ===
        // ============================================
        async function startDetective() {
            const setup = await getCamera();
            if(!setup) return;
            const { video, stream } = setup;

            const canvas = document.createElement('canvas');
            viewport.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            const model = await cocoSsd.load();
            let running = true;

            async function loop() {
                if(!running) return;
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                
                const preds = await model.detect(video);
                preds.forEach(p => {
                    // Batman Styling
                    let label = p.class.toUpperCase();
                    let color = "#00f7ff";
                    if(label === "PERSON") { label = "HUMAN"; color = "#ff3333"; }
                    if(label === "CELL PHONE") { label = "TECH"; color = "#eebb00"; }
                    
                    ctx.strokeStyle = color; ctx.lineWidth = 3;
                    ctx.strokeRect(p.bbox[0], p.bbox[1], p.bbox[2], p.bbox[3]);
                    
                    const textW = ctx.measureText(label).width;
                    ctx.fillStyle = color; 
                    ctx.fillRect(p.bbox[0], p.bbox[1]-20, textW+10, 20);
                    ctx.fillStyle = "black"; ctx.font = "bold 14px Arial";
                    ctx.fillText(label, p.bbox[0]+5, p.bbox[1]-5);
                });
                requestAnimationFrame(loop);
            }
            loop();

            currentProcess = () => { running = false; stream.getTracks().forEach(t => t.stop()); video.remove(); canvas.remove(); };
        }

        // ============================================
        // === APP: NIGHT VISION / FILTERS ===
        // ============================================
        async function startCamera(filter) {
            const setup = await getCamera();
            if(!setup) return;
            setup.video.style.filter = filter;
            currentProcess = () => { setup.stream.getTracks().forEach(t => t.stop()); setup.video.remove(); };
        }

        // ============================================
        // === APP: SONAR (Audio) ===
        // ============================================
        async function startSonar() {
            const canvas = document.createElement('canvas');
            viewport.appendChild(canvas);
            const ctx = canvas.getContext('2d');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const actx = new (window.AudioContext||window.webkitAudioContext)();
                const src = actx.createMediaStreamSource(stream);
                const ana = actx.createAnalyser();
                src.connect(ana);
                
                const data = new Uint8Array(ana.frequencyBinCount);
                let running = true;

                function draw() {
                    if(!running) return;
                    ana.getByteFrequencyData(data);
                    canvas.width = viewport.clientWidth; canvas.height = viewport.clientHeight;
                    
                    // Radar Grid
                    ctx.strokeStyle = "#004444"; ctx.lineWidth=1;
                    ctx.beginPath(); ctx.arc(canvas.width/2, canvas.height/2, 100, 0, 2*Math.PI); ctx.stroke();
                    
                    // Bars
                    let x = 0; let w = canvas.width / data.length * 2.5;
                    for(let i=0; i<data.length; i++) {
                        let h = data[i] * 3;
                        ctx.fillStyle = `rgba(0, ${255}, 255, ${data[i]/255})`;
                        ctx.fillRect(x, canvas.height/2 - h/2, w, h);
                        x += w+1;
                    }
                    requestAnimationFrame(draw);
                }
                draw();
                
                currentProcess = () => { running = false; stream.getTracks().forEach(t => t.stop()); actx.close(); canvas.remove(); };
            } catch(e) { alert("Mic Access Denied"); }
        }

        // ============================================
        // === APP: JAMMER (White Noise) ===
        // ============================================
        function startJammer() {
            const ui = document.createElement('div');
            ui.className = 'tool-ui';
            ui.innerHTML = `<button class="action" style="height:200px; border-radius:50%; margin-top:50px;" onclick="toggleNoise()">TOGGLE JAMMER</button><div style="text-align:center; margin-top:20px;">AUDIO MASKING ACTIVE</div>`;
            viewport.appendChild(ui);

            let actx = null;
            window.toggleNoise = () => {
                if(actx) { actx.close(); actx = null; return; }
                actx = new (window.AudioContext||window.webkitAudioContext)();
                const node = actx.createScriptProcessor(4096, 1, 1);
                node.onaudioprocess = e => {
                    const out = e.outputBuffer.getChannelData(0);
                    for(let i=0; i<4096; i++) out[i] = Math.random() * 2 - 1;
                };
                node.connect(actx.destination);
            };
            currentProcess = () => { if(actx) actx.close(); ui.remove(); };
        }

        // ============================================
        // === UTILITIES (GPS, Crypto, Status) ===
        // ============================================
        function startGPS() {
            const ui = document.createElement('div');
            ui.className = 'tool-ui';
            ui.innerHTML = `<div id="gps-data" class="log-box" style="height:200px; font-size:16px;">ACQUIRING SATELLITES...</div>`;
            viewport.appendChild(ui);
            
            const id = navigator.geolocation.watchPosition(
                p => { document.getElementById('gps-data').innerHTML = `LAT: ${p.coords.latitude}<br>LON: ${p.coords.longitude}<br>ALT: ${p.coords.altitude||0}m<br>SPD: ${p.coords.speed||0}m/s`; },
                e => { document.getElementById('gps-data').innerText = "SIGNAL LOST"; },
                { enableHighAccuracy: true }
            );
            currentProcess = () => { navigator.geolocation.clearWatch(id); ui.remove(); };
        }

        function startCrypto() {
            const ui = document.createElement('div');
            ui.className = 'tool-ui';
            ui.innerHTML = `<textarea id="c-in" placeholder="Input"></textarea><button class="action" onclick="runRot13()">ENCRYPT/DECRYPT</button><textarea id="c-out" readonly placeholder="Output"></textarea>`;
            viewport.appendChild(ui);
            window.runRot13 = () => {
                const s = document.getElementById('c-in').value;
                document.getElementById('c-out').value = s.replace(/[a-zA-Z]/g,c=>String.fromCharCode((c<="Z"?90:122)>=(c=c.charCodeAt(0)+13)?c:c-26));
            };
            currentProcess = () => { ui.remove(); };
        }

        function startFlash() {
            const bg = document.body;
            let i = setInterval(() => { bg.style.backgroundColor = bg.style.backgroundColor==='white'?'black':'white'; }, 80);
            currentProcess = () => { clearInterval(i); bg.style.backgroundColor = 'var(--bg)'; };
        }

        async function startStatus() {
            const ui = document.createElement('div');
            ui.className = 'tool-ui';
            viewport.appendChild(ui);
            
            const update = async () => {
                let bat = navigator.getBattery ? await navigator.getBattery() : {level:1};
                ui.innerHTML = `
                    <div class="log-box">
                    BATTERY: ${Math.round(bat.level*100)}%<br>
                    CORES: ${navigator.hardwareConcurrency}<br>
                    RAM: ${navigator.deviceMemory || '?'} GB<br>
                    PLATFORM: ${navigator.platform}<br>
                    AGENT: ${navigator.userAgent}
                    </div>
                `;
            };
            update();
            currentProcess = () => { ui.remove(); };
        }
        
    </script>
</body>
</html>
