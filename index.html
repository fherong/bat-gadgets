<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WayneTech OS v6</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wayne: '#00f7ff',
                        alert: '#ff3333',
                        panel: '#0a0a0a',
                    },
                    fontFamily: {
                        mono: ['Courier New', 'monospace'],
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

    <style>
        body { background-color: black; color: #00f7ff; overflow: hidden; touch-action: none; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #00f7ff; border-radius: 5px; }
        
        /* CRT Scanline Effect */
        .scanline {
            width: 100%; height: 100%; position: fixed; left: 0; top: 0; pointer-events: none; z-index: 50;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
        }
        
        /* Night Vision Filter */
        .nv-filter { filter: sepia(100%) hue-rotate(90deg) contrast(200%) brightness(150%) grayscale(20%); }
        
        /* OCR Target Box */
        .ocr-target {
            border: 2px solid #00f7ff; box-shadow: 0 0 15px #00f7ff;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 100px; z-index: 20; pointer-events: none;
        }
        .ocr-target::after { content: "TARGET TEXT HERE"; position: absolute; top: -20px; left: 0; font-size: 12px; background: black; padding: 2px 5px; }
    </style>
</head>
<body class="font-mono h-screen w-screen flex flex-col">

    <div class="scanline"></div>

    <header class="h-14 flex items-center justify-between px-4 border-b-2 border-wayne bg-black/90 z-40">
        <div class="text-xl font-bold tracking-widest text-wayne drop-shadow-[0_0_5px_rgba(0,247,255,0.8)]">WAYNETECH</div>
        <div id="clock" class="text-xs text-wayne/70">00:00:00</div>
    </header>

    <main id="viewport" class="flex-1 relative bg-black overflow-hidden">
        
        <div id="home" class="screen w-full h-full p-4 grid grid-cols-2 gap-4 overflow-y-auto pb-20">
            <button onclick="launch('detective')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üëÅÔ∏è</span> <span class="text-xs font-bold">DETECTIVE</span>
            </button>
            <button onclick="launch('vocoder')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üó£Ô∏è</span> <span class="text-xs font-bold">VOCODER</span>
            </button>
            <button onclick="launch('nightvis')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üåë</span> <span class="text-xs font-bold">NIGHT VIS</span>
            </button>
            <button onclick="launch('sonar')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üì°</span> <span class="text-xs font-bold">SONAR</span>
            </button>
            <button onclick="launch('logs')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üìù</span> <span class="text-xs font-bold">LOGS</span>
            </button>
            <button onclick="launch('units')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üìê</span> <span class="text-xs font-bold">UNITS</span>
            </button>
            <button onclick="launch('chrono')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">‚è±Ô∏è</span> <span class="text-xs font-bold">CHRONO</span>
            </button>
            <button onclick="launch('rng')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üé≤</span> <span class="text-xs font-bold">RNG</span>
            </button>
            <button onclick="launch('tally')" class="flex flex-col items-center justify-center p-4 border border-wayne/30 bg-wayne/5 rounded active:bg-wayne active:text-black transition">
                <span class="text-3xl mb-2">üî¢</span> <span class="text-xs font-bold">TALLY</span>
            </button>
            <button onclick="launch('flash')" class="flex flex-col items-center justify-center p-4 border border-red-500/50 bg-red-900/10 rounded active:bg-red-500 active:text-black transition text-red-500">
                <span class="text-3xl mb-2">üí£</span> <span class="text-xs font-bold">FLASHBANG</span>
            </button>
        </div>

        <div id="app-detective" class="screen hidden w-full h-full relative">
            <video id="det-vid" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
            <canvas id="det-can" class="absolute inset-0 w-full h-full object-cover z-10"></canvas>
            <div class="absolute bottom-5 left-0 w-full px-4 z-20">
                <div class="bg-black/80 border border-wayne p-2 rounded">
                    <div class="flex justify-between text-xs mb-1">
                        <span>CONFIDENCE THRESHOLD</span>
                        <span id="det-val">60%</span>
                    </div>
                    <input type="range" min="10" max="90" value="60" oninput="updateThresh(this.value)" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                </div>
            </div>
        </div>

        <div id="app-vocoder" class="screen hidden w-full h-full flex flex-col">
            <div class="flex border-b border-wayne">
                <button onclick="vocoderTab('speech')" class="flex-1 p-3 bg-wayne/10 text-xs font-bold active:bg-wayne active:text-black">üé§ SPEECH</button>
                <button onclick="vocoderTab('cam')" class="flex-1 p-3 bg-wayne/10 text-xs font-bold active:bg-wayne active:text-black border-l border-wayne">üì∑ CAM OCR</button>
            </div>

            <div id="voc-tab-speech" class="flex-1 flex flex-col p-4 space-y-4">
                <button onclick="startListening()" class="p-6 border-2 border-wayne rounded-full mx-auto mt-4 active:bg-wayne active:text-black transition">
                    <span class="text-4xl">üéôÔ∏è</span>
                </button>
                <div class="text-center text-xs opacity-70">TAP TO SPEAK</div>
                
                <textarea id="voc-text" class="w-full h-32 bg-gray-900 border border-wayne p-2 text-sm rounded focus:outline-none" placeholder="Detected text..."></textarea>
                
                <div class="flex gap-2">
                    <select id="voc-lang" class="bg-gray-900 border border-wayne p-2 text-sm flex-1 rounded">
                        <option value="es-ES">Spanish</option>
                        <option value="fr-FR">French</option>
                        <option value="ja-JP">Japanese</option>
                        <option value="de-DE">German</option>
                        <option value="ru-RU">Russian</option>
                    </select>
                    <button onclick="speakTranslation()" class="px-4 py-2 bg-wayne/20 border border-wayne rounded font-bold">SPEAK</button>
                </div>
            </div>

            <div id="voc-tab-cam" class="hidden flex-1 relative">
                <video id="voc-vid" class="absolute inset-0 w-full h-full object-cover" autoplay playsinline muted></video>
                <div class="ocr-target"></div>
                <div class="absolute bottom-5 w-full px-10">
                    <button onclick="captureOCR()" class="w-full py-4 bg-wayne text-black font-bold text-lg rounded shadow-[0_0_15px_#00f7ff]">SCAN TARGET AREA</button>
                </div>
                <div id="ocr-result" class="absolute top-5 left-5 right-5 bg-black/90 border border-wayne p-2 text-sm min-h-[50px] z-20">Ready to scan...</div>
            </div>
        </div>

        <div id="app-nightvis" class="screen hidden w-full h-full relative">
            <video id="nv-vid" class="absolute inset-0 w-full h-full object-cover nv-filter" autoplay playsinline muted></video>
            <div class="absolute bottom-10 w-full text-center text-wayne font-bold text-xl drop-shadow-md">NIGHT VISION ACTIVE</div>
        </div>

        <div id="app-sonar" class="screen hidden w-full h-full relative bg-black">
            <canvas id="sonar-can" class="w-full h-full"></canvas>
            <div class="absolute top-4 right-4 text-xs">AUDIO SPECTRUM ANALYZER</div>
        </div>

        <div id="app-logs" class="screen hidden w-full h-full flex flex-col p-4">
            <textarea id="log-input" class="w-full h-24 bg-gray-900 border border-wayne p-2 mb-2 rounded" placeholder="Mission entry..."></textarea>
            <button onclick="addLog()" class="w-full py-3 bg-wayne/20 border border-wayne mb-4 font-bold rounded">SAVE LOG</button>
            <div id="log-list" class="flex-1 overflow-y-auto space-y-2 border-t border-wayne/30 pt-2">
                </div>
        </div>

        <div id="app-units" class="screen hidden w-full h-full flex flex-col p-4 space-y-4">
            <div class="bg-gray-900 p-4 border border-wayne rounded">
                <label class="text-xs">METERS</label>
                <input type="number" id="unit-m" oninput="convertUnits('m')" class="w-full bg-black border border-wayne p-2 text-xl" placeholder="0">
            </div>
            <div class="text-center text-2xl">‚¨áÔ∏è</div>
            <div class="bg-gray-900 p-4 border border-wayne rounded">
                <label class="text-xs">FEET</label>
                <input type="number" id="unit-ft" oninput="convertUnits('ft')" class="w-full bg-black border border-wayne p-2 text-xl" placeholder="0">
            </div>
        </div>

        <div id="app-chrono" class="screen hidden w-full h-full flex flex-col justify-center items-center p-4">
            <div id="chrono-display" class="text-6xl font-bold mb-8 font-mono">00:00.00</div>
            <div class="grid grid-cols-2 gap-4 w-full max-w-xs">
                <button onclick="toggleChrono()" class="py-4 bg-wayne/20 border border-wayne rounded text-xl font-bold">START/STOP</button>
                <button onclick="resetChrono()" class="py-4 bg-red-900/20 border border-red-500 text-red-500 rounded text-xl font-bold">RESET</button>
            </div>
        </div>

        <div id="app-rng" class="screen hidden w-full h-full flex flex-col p-4">
            <div id="rng-display" class="flex-1 flex justify-center items-center text-9xl font-bold text-wayne">?</div>
            <div class="grid grid-cols-2 gap-4 h-24">
                <button onclick="roll(6)" class="bg-wayne/10 border border-wayne rounded font-bold">D6</button>
                <button onclick="roll(20)" class="bg-wayne/10 border border-wayne rounded font-bold">D20</button>
                <button onclick="flipCoin()" class="col-span-2 bg-wayne/10 border border-wayne rounded font-bold">FLIP COIN</button>
            </div>
        </div>

        <div id="app-tally" class="screen hidden w-full h-full flex flex-col p-4">
            <div id="tally-val" class="flex-1 flex justify-center items-center text-9xl font-bold" onclick="updateTally(1)">0</div>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="updateTally(-1)" class="py-4 border border-wayne rounded bg-wayne/10 font-bold">-</button>
                <button onclick="updateTally(0)" class="py-4 border border-alert text-alert rounded bg-alert/10 font-bold">RESET</button>
            </div>
        </div>

        <div id="app-flash" class="screen hidden w-full h-full bg-white z-50 flex justify-center items-center cursor-pointer" onclick="toggleStrobe()">
            <h1 class="text-black font-bold text-4xl select-none">TAP TO<br>STROBE</h1>
        </div>

    </main>

    <nav class="h-16 border-t border-wayne/30 bg-black flex justify-center items-center z-40">
        <button onclick="goHome()" class="px-8 py-2 bg-wayne/10 border border-wayne text-wayne rounded hover:bg-wayne hover:text-black transition font-bold tracking-widest">
            MENU
        </button>
    </nav>

    <script>
        // --- CORE SYSTEM ---
        let currentStream = null;
        let animationId = null;
        let activeApp = null;
        
        // Clock
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }, 1000);

        function goHome() {
            stopHardware();
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('home').classList.remove('hidden');
            activeApp = null;
        }

        function launch(appId) {
            goHome(); // Clean state
            document.getElementById('home').classList.add('hidden');
            document.getElementById('app-' + appId).classList.remove('hidden');
            activeApp = appId;

            if(appId === 'detective') initDetective();
            if(appId === 'nightvis') initCamera('nv-vid');
            if(appId === 'sonar') initSonar();
            if(appId === 'vocoder') initVocoderCam();
            if(appId === 'logs') loadLogs();
        }

        function stopHardware() {
            if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); currentStream = null; }
            if (animationId) { cancelAnimationFrame(animationId); clearInterval(animationId); animationId = null; }
            const flash = document.getElementById('app-flash');
            flash.style.backgroundColor = 'white'; // Reset flashbang state
        }

        async function getCamera() {
            try {
                return await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
            } catch(e) { alert("Camera Denied"); return null; }
        }

        // --- 1. DETECTIVE (Fixed Overlay) ---
        let detModel = null;
        let detThresh = 0.60;
        function updateThresh(val) { detThresh = val / 100; document.getElementById('det-val').innerText = val + '%'; }

        async function initDetective() {
            const video = document.getElementById('det-vid');
            const canvas = document.getElementById('det-can');
            const ctx = canvas.getContext('2d');
            
            const stream = await getCamera();
            if(!stream) return;
            video.srcObject = stream;
            currentStream = stream;

            if(!detModel) detModel = await cocoSsd.load();

            async function detect() {
                if(activeApp !== 'detective') return;
                
                // Ensure canvas matches video size exactly
                if(video.readyState === 4) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    const preds = await detModel.detect(video);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    preds.forEach(p => {
                        if(p.score < detThresh) return; // Sensitivity check

                        let label = p.class.toUpperCase();
                        let color = '#00f7ff';
                        if(label === 'PERSON') { color = '#ff3333'; label = 'HUMAN'; }
                        if(label === 'CELL PHONE') { color = '#FFFF00'; label = 'TECH'; }

                        ctx.strokeStyle = color;
                        ctx.lineWidth = 4;
                        ctx.strokeRect(p.bbox[0], p.bbox[1], p.bbox[2], p.bbox[3]);

                        ctx.fillStyle = color;
                        ctx.font = 'bold 16px Courier New';
                        ctx.fillText(`${label} ${Math.round(p.score*100)}%`, p.bbox[0], p.bbox[1] - 5);
                    });
                }
                animationId = requestAnimationFrame(detect);
            }
            detect();
        }

        // --- 2. VOCODER (Fixed) ---
        function vocoderTab(tab) {
            document.getElementById('voc-tab-speech').classList.add('hidden');
            document.getElementById('voc-tab-cam').classList.add('hidden');
            document.getElementById('voc-tab-' + tab).classList.remove('hidden');
        }

        // Speech Logic
        function startListening() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRecognition) { alert("Speech API not supported on this browser."); return; }
            
            const rec = new SpeechRecognition();
            rec.lang = 'en-US';
            rec.onstart = () => { document.getElementById('voc-text').placeholder = "Listening..."; };
            rec.onresult = (e) => { document.getElementById('voc-text').value = e.results[0][0].transcript; };
            rec.start();
        }

        function speakTranslation() {
            const text = document.getElementById('voc-text').value;
            const lang = document.getElementById('voc-lang').value;
            if(!text) return;
            
            const u = new SpeechSynthesisUtterance(text); // In a real app, you'd translate text via API here first
            u.lang = lang;
            speechSynthesis.speak(u);
        }

        // Cam OCR Logic
        async function initVocoderCam() {
            const video = document.getElementById('voc-vid');
            const stream = await getCamera();
            if(stream) { video.srcObject = stream; currentStream = stream; }
        }

        async function captureOCR() {
            const video = document.getElementById('voc-vid');
            const res = document.getElementById('ocr-result');
            res.innerText = "Scanning Target Area...";
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Capture full frame
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // CROP THE CENTER (Where the target box is)
            // We assume target box is roughly 80% width and 100px height centered
            const cropW = canvas.width * 0.8;
            const cropH = 100 * (canvas.width / video.clientWidth); // Scale height relative to view
            const cropX = (canvas.width - cropW) / 2;
            const cropY = (canvas.height - cropH) / 2;

            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = cropW;
            cropCanvas.height = cropH;
            cropCanvas.getContext('2d').drawImage(canvas, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            // Run Tesseract on cropped image
            Tesseract.recognize(cropCanvas, 'eng')
                .then(({ data: { text } }) => {
                    res.innerText = text ? text : "No Text Found";
                });
        }

        // --- 3. NIGHT VIS ---
        async function initCamera(id) {
            const vid = document.getElementById(id);
            const stream = await getCamera();
            if(stream) { vid.srcObject = stream; currentStream = stream; }
        }

        // --- 4. SONAR ---
        async function initSonar() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                currentStream = stream;
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const src = ctx.createMediaStreamSource(stream);
                const ana = ctx.createAnalyser();
                ana.fftSize = 256;
                src.connect(ana);
                
                const canvas = document.getElementById('sonar-can');
                const cCtx = canvas.getContext('2d');
                const data = new Uint8Array(ana.frequencyBinCount);

                function draw() {
                    if(activeApp !== 'sonar') return;
                    
                    // Resize canvas to match display
                    canvas.width = canvas.clientWidth;
                    canvas.height = canvas.clientHeight;

                    ana.getByteFrequencyData(data);
                    
                    cCtx.fillStyle = '#000';
                    cCtx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    const barWidth = (canvas.width / data.length) * 2.5;
                    let x = 0;

                    for(let i = 0; i < data.length; i++) {
                        const barHeight = (data[i] / 255) * canvas.height;
                        
                        // WayneTech Color Scheme
                        cCtx.fillStyle = `rgba(0, 247, 255, ${data[i]/255})`;
                        cCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                        x += barWidth + 1;
                    }
                    animationId = requestAnimationFrame(draw);
                }
                draw();
            } catch(e) { alert("Microphone Denied"); }
        }

        // --- 5. LOGS ---
        function addLog() {
            const input = document.getElementById('log-input');
            if(!input.value) return;
            const logs = JSON.parse(localStorage.getItem('wayne_logs') || '[]');
            logs.unshift(`${new Date().toLocaleTimeString()}: ${input.value}`);
            localStorage.setItem('wayne_logs', JSON.stringify(logs));
            input.value = '';
            loadLogs();
        }
        function loadLogs() {
            const list = document.getElementById('log-list');
            const logs = JSON.parse(localStorage.getItem('wayne_logs') || '[]');
            list.innerHTML = logs.map(l => `<div class="p-2 border-b border-wayne/30 text-xs">${l}</div>`).join('');
        }

        // --- 6. UNITS ---
        function convertUnits(type) {
            const m = document.getElementById('unit-m');
            const ft = document.getElementById('unit-ft');
            if(type === 'm') ft.value = (m.value * 3.28084).toFixed(2);
            else m.value = (ft.value / 3.28084).toFixed(2);
        }

        // --- 7. CHRONO ---
        let chronoStart = 0;
        let chronoInt = null;
        function toggleChrono() {
            if(chronoInt) { clearInterval(chronoInt); chronoInt = null; }
            else {
                chronoStart = Date.now() - (chronoStart > 0 ? chronoStart : 0);
                chronoInt = setInterval(() => {
                    const d = new Date(Date.now() - chronoStart);
                    document.getElementById('chrono-display').innerText = d.toISOString().substr(14, 8);
                }, 10);
                animationId = chronoInt; // Hijack this var for cleanup
            }
        }
        function resetChrono() {
            clearInterval(chronoInt); chronoInt = null; chronoStart = 0;
            document.getElementById('chrono-display').innerText = "00:00.00";
        }

        // --- 8. RNG ---
        function roll(max) { document.getElementById('rng-display').innerText = Math.floor(Math.random()*max)+1; }
        function flipCoin() { document.getElementById('rng-display').innerText = Math.random()>0.5 ? "HEADS" : "TAILS"; }

        // --- 9. TALLY ---
        function updateTally(n) {
            const el = document.getElementById('tally-val');
            if(n === 0) el.innerText = 0;
            else el.innerText = parseInt(el.innerText) + n;
        }

        // --- 10. FLASHBANG ---
        function toggleStrobe() {
            const el = document.getElementById('app-flash');
            if(animationId) { clearInterval(animationId); animationId = null; el.style.backgroundColor = 'white'; }
            else {
                animationId = setInterval(() => {
                    el.style.backgroundColor = el.style.backgroundColor === 'white' ? 'black' : 'white';
                }, 50);
            }
        }

    </script>
</body>
</html>
